name: CI/CD

on:
  push:
    branches:
      - 'master*'
      - 'devel-*'
    tags:
      - '*'
  pull_request:
  schedule:
    - cron: '10 9 1 * *'
  workflow_dispatch:
permissions: {}

jobs:
  publish-docker-v2:
    name: Publish Test Results (Docker v2)
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
      actions: read

    steps:
      - name: Publish Test Results
        id: test-results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: Test Results (Docker v2)
          files: "artifacts/**/*.xml"
          json_file: "tests.json"
          json_suite_details: true
          json_test_case_results: true
          report_suite_logs: "any"
          log_level: DEBUG

      - name: Env
        run: env
        shell: bash

      - name: Log
        run: |
          echo curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/logs
          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID/logs
        shell: bash

  publish-docker-action:
    name: Publish Test Results (Docker action)
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish Test Results
        id: test-results
        uses: ./docker
        with:
          check_name: Test Results (Docker action)
          files: "artifacts/**/*.xml"
          json_file: "tests.json"
          json_suite_details: true
          json_test_case_results: true
          report_suite_logs: "any"
          log_level: DEBUG

  event_file:
    name: "Event File"
    runs-on: ubuntu-latest
    steps:
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Event File
          path: ${{ github.event_path }}
